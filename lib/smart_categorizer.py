"""
æ™ºèƒ½åˆ†ç±»å™¨
æ ¹æ®äº¤æ˜“å¯¹æ–¹å’Œäº¤æ˜“ç±»å‹æ™ºèƒ½è¯†åˆ«åˆ†ç±»
"""


class SmartCategorizer:
    """æ™ºèƒ½åˆ†ç±»å™¨"""

    # å…³é”®è¯æ˜ å°„è§„åˆ™
    KEYWORD_RULES = {
        'é¤é¥®': [
            'é¤', 'é¥­', 'é£Ÿ', 'åƒ', 'å¤–å–', 'ç¾å›¢', 'é¥¿äº†ä¹ˆ', 'éº¦å½“åŠ³', 'è‚¯å¾·åŸº',
            'æ˜Ÿå·´å…‹', 'ç‘å¹¸', 'å’–å•¡', 'å¥¶èŒ¶', 'èŒ¶é¥®', 'çƒ§çƒ¤', 'ç«é”…', 'å°åƒ',
            'å¿«é¤', 'é¢é¦†', 'ç²‰åº—', 'é¥ºå­', 'åŒ…å­', 'æ—©é¤', 'åˆé¤', 'æ™šé¤',
            'ç”œå“', 'è›‹ç³•', 'é¢åŒ…', 'çƒ˜ç„™', 'æµ·åº•æ', 'KFC', 'å¿…èƒœå®¢'
        ],
        'äº¤é€š': [
            'äº¤é€š', 'å‡ºè¡Œ', 'æ»´æ»´', 'æ‰“è½¦', 'ä»£é©¾', 'åœè½¦', 'åŠ æ²¹', 'æ²¹è´¹',
            'åœ°é“', 'å…¬äº¤', 'å…±äº«å•è½¦', 'éª‘è¡Œ', 'é«˜é“', 'ç«è½¦', 'æœºç¥¨', 'èˆªç©º',
            'æ±½è½¦ç¥¨', 'è¿‡è·¯è´¹', 'ETC', 'æ´—è½¦', '12306', 'æºç¨‹', 'å»å“ªå„¿',
            'é£çŒª', 'å“ˆå•°', 'ç¾å›¢å•è½¦', 'é’æ¡”', 'è½®èƒ'
        ],
        'è´­ç‰©': [
            'è´­ç‰©', 'å•†åŸ', 'è¶…å¸‚', 'ä¾¿åˆ©åº—', 'æ·˜å®', 'å¤©çŒ«', 'äº¬ä¸œ', 'æ‹¼å¤šå¤š',
            'è‹å®', 'å”¯å“ä¼š', 'å°ç±³', 'åä¸º', 'è‹¹æœ', 'æœè£…', 'é‹', 'åŒ…',
            'åŒ–å¦†å“', 'æŠ¤è‚¤', 'å®¶ç”µ', 'æ•°ç ', 'æ‰‹æœº', 'ç”µè„‘', 'è€³æœº',
            'æ–‡å…·', 'å›¾ä¹¦', 'ç©å…·', 'æ—¥ç”¨å“', 'é›¶é£Ÿ', 'é¥®æ–™', '7-11',
            'å…¨å®¶', 'ç½—æ£®', 'å±ˆè‡£æ°', 'æ²ƒå°”ç›', 'å®¶ä¹ç¦', 'ç›’é©¬', 'å±±å§†',
            'å¾—ç‰©', 'æå®', 'å›åŠ›', 'miåº—', 'suåº—', 'bjåº—', 'é“¶å¿ƒé“º',
            'å¸›è¯—', 'æŸä¸', 'çŒ«äºº', 'è“è‰²', 'è´Ÿä¸€', 'å˜‰', 'tb', 'ypåº—',
            'è–›ä¹‹', 'é“ƒé“›', 'daèˆ°', 'nak', 'pidan', 'æ¬§è€', 'éš”èŠ±', 'å¤é‡‘',
            'GS25', '7-Eleven', 'CU', 'e-mart', 'éŸ©å›½', 'ä¾¿åˆ©åº—'
        ],
        'å¨±ä¹': [
            'å¨±ä¹', 'ç”µå½±', 'å½±é™¢', 'æ¸¸æˆ', 'ç½‘å§', 'Steam', 'ç‹è€…è£è€€',
            'KTV', 'é…’å§', 'å¥èº«', 'æ¸¸æ³³', 'çƒé¦†', 'å°çƒ', 'å‰§æœ¬æ€',
            'å¯†å®¤é€ƒè„±', 'éŸ³ä¹', 'æ¼”å”±ä¼š', 'è¯å‰§', 'å±•è§ˆ', 'åšç‰©é¦†',
            'æ¸¸ä¹åœº', 'çˆ±å¥‡è‰º', 'è…¾è®¯è§†é¢‘', 'ä¼˜é…·', 'Netflix', 'QQéŸ³ä¹',
            'ç½‘æ˜“äº‘éŸ³ä¹', 'Spotify', 'Apple Music', 'Bç«™', 'å“”å“©å“”å“©',
            'å®Œç¾ä¸–ç•Œ', 'å››ä¸‰ä¹ä¹', 'å›½æˆ˜ä¼ å¥‡', 'æŠ–éŸ³ç”Ÿæ´»æœåŠ¡'
        ],
        'å›ºå®šæ”¯å‡º': [
            'æ°´ç”µ', 'ç‰©ä¸š', 'ç‡ƒæ°”', 'å®½å¸¦', 'è¯è´¹', 'å……å€¼', 'ç¼´è´¹',
            'ç”µè´¹', 'æ°´è´¹', 'æš–æ°”', 'æˆ¿ç§Ÿ', 'æˆ¿ä¸œ'
        ],
        'å®¶ç”¨': [
            'å®¶æ”¿', 'ç»´ä¿®', 'è£…ä¿®', 'å®¶å…·', 'å®¶å±…',
            'åºŠä¸Šç”¨å“', 'å¨å…·', 'æ¸…æ´', 'æ´—è¡£', 'ç”µä¿¡', 'ç§»åŠ¨', 'è”é€š'
        ],
        'åŒ»ç–—': [
            'åŒ»é™¢', 'è¯Šæ‰€', 'è¯åº—', 'ä½“æ£€', 'çœ‹ç—…', 'æŒ‚å·', 'è¯', 'åŒ»ç–—',
            'ç‰™ç§‘', 'çœ¼ç§‘', 'ç¾å¹´å¤§å¥åº·', 'çˆ±åº·', 'ç‘æ…ˆ', 'ä¸é¦™', 'å¹³å®‰å¥½åŒ»ç”Ÿ',
            'æ˜¥é›¨åŒ»ç”Ÿ', 'ç–«è‹—', 'ä¿å¥å“', 'ç»´ç”Ÿç´ '
        ],
        'å­¦ä¹ åŠå…¬': [
            'æ•™è‚²', 'åŸ¹è®­', 'è¯¾ç¨‹', 'å­¦è´¹', 'ä¹¦ç±', 'æ–‡å…·', 'åŠå…¬',
            'æ‰“å°', 'å¤å°', 'çŸ¥ç½‘', 'å¾—åˆ°', 'å–œé©¬æ‹‰é›…', 'ç½‘è¯¾', 'åœ¨çº¿æ•™è‚²',
            'è‹±è¯­', 'é©¾æ ¡', 'è¯ä¹¦', 'è€ƒè¯•', 'æŠ¥åè´¹', 'Coursera', 'Udemy',
            'è…¾è®¯è¯¾å ‚', 'ç½‘æ˜“äº‘è¯¾å ‚', 'è€ƒç ”', 'å…¬è€ƒ', 'æ·±åº¦æ±‚ç´¢', 'ç™¾åº¦',
            'é˜¿é‡Œäº‘', 'äº‘æœåŠ¡', 'åŸŸå', 'æœåŠ¡å™¨', 'RACKNERD', 'å®æ³¢å¸‚å¥‰åŒ–åŒºé»‘æ–¹ä½“'
        ],
        'ç†å‘ç¾å®¹': [
            'ç†å‘', 'ç¾å‘', 'é€ å‹', 'å‰ªå‘', 'æŸ“å‘', 'çƒ«å‘', 'INSTYLE',
            'XZHAIRSALON', 'å·¥ä½œå®¤', 'ç¾å®¹', 'ç¾ç”²', 'æŒ‰æ‘©', 'SPA',
            'å‡¯æ—‹', 'é˜¿æ³½å·¥ä½œå®¤', '3AM'
        ],
        'å®¶åº­æ”¯å‡º': [
            'ç¬¨è›‹è›‹', 'è›‹è›‹', 'ã®ç´¾', 'å¦ˆå¦ˆ', 'æ¯äº²', 'çˆ¸çˆ¸', 'çˆ¶äº²',
            'ç»™å¦ˆå¦ˆ', 'ç»™çˆ¸çˆ¸', 'ç»™å¯¹è±¡', 'ç»™å®¶äºº'
        ],
        'çº¢åŒ…è½¬è´¦': [
            'çº¢åŒ…', 'è½¬è´¦', 'æç°', 'å……å€¼', 'é€€æ¬¾', 'è¿˜æ¬¾', 'å€Ÿæ¬¾',
            'å°è·åŒ…', 'æ”¯ä»˜å®å°è·åŒ…', 'å¾®ä¿¡çº¢åŒ…'
        ],
        'è´·æ¬¾': [
            'è´·æ¬¾', 'èŠ±å‘—', 'å€Ÿå‘—', 'ä¿¡ç”¨å¡', 'åˆ†æœŸ', 'ä¸­èå°é¢è´·æ¬¾'
        ],
        'å…¶ä»–æ”¶å…¥': [
            'å·¥èµ„', 'å¥–é‡‘', 'æŠ¥é”€', 'é€€ç¨', 'ç†è´¢', 'è‚¡ç¥¨', 'åŸºé‡‘', 'åˆ©æ¯',
            'åˆ†çº¢', 'ä½£é‡‘', 'ç¨¿è´¹', 'å…¼èŒ', 'è¡¥è´´', 'çº¢åŒ…æ”¶å…¥'
        ]
    }

    # ç‰¹æ®Šäº¤æ˜“å¯¹æ–¹æ˜ å°„(ç²¾ç¡®åŒ¹é…ä¼˜å…ˆ)
    EXACT_MERCHANT_MAP = {
        # å®¶åº­æ”¯å‡º
        'ç¬¨è›‹è›‹ğŸ¥š': 'å®¶åº­æ”¯å‡º',
        'ã®ç´¾...x.ãƒ': 'å®¶åº­æ”¯å‡º',
        'åŸ¹': 'å®¶åº­æ”¯å‡º',  # å¯èƒ½æ˜¯å®¶äºº
        'ä¼Ÿ': 'å®¶åº­æ”¯å‡º',  # å¯èƒ½æ˜¯å®¶äºº/æœ‹å‹

        # å›ºå®šæ”¯å‡º(æˆ¿ç§Ÿç­‰)
        'æˆ¿ä¸œ': 'å›ºå®šæ”¯å‡º',
        'ä½ æœ‰æœ¬äº‹å·èƒ½é‡ ä½ æœ‰æœ¬äº‹æµ‡æ°´å•Š': 'å›ºå®šæ”¯å‡º',
        'ä¸Šæµ·å…¬å…±æ”¯ä»˜ä¸€ç½‘é€šåŠ': 'å›ºå®šæ”¯å‡º',  # æ”¿åŠ¡ç¼´è´¹

        # å¨±ä¹
        'Steam': 'å¨±ä¹',
        'å®Œç¾ä¸–ç•Œ': 'å¨±ä¹',
        'å››ä¸‰ä¹ä¹ç½‘ç»œè‚¡ä»½æœ‰é™å…¬å¸': 'å¨±ä¹',
        'å›½æˆ˜ä¼ å¥‡': 'å¨±ä¹',
        'åŒ—äº¬å¡è·¯é‡Œç§‘æŠ€æœ‰é™å…¬å¸': 'å¨±ä¹',  # å¥èº«APP
        'è¥¿å®‰å¥¥ä½“ä¸­å¿ƒå•†ä¸šç§Ÿèµ': 'å¨±ä¹',  # ä½“è‚²åœºé¦†

        # è´·æ¬¾
        'æ·±åœ³å¸‚ä¸­èå°é¢è´·æ¬¾æœ‰é™å…¬å¸': 'è´·æ¬¾',

        # è´­ç‰©
        'å¾—ç‰©': 'è´­ç‰©',
        'pidan Gallery': 'è´­ç‰©',
        'é˜¿é‡Œå·´å·´1688plusä¼šå‘˜': 'è´­ç‰©',
        'ä¸Šæµ·æ ¼ç‰©è‡´å“ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸': 'è´­ç‰©',
        'éº¦ç‹„åº—': 'è´­ç‰©',
        'suçŒ«': 'è´­ç‰©',
        'nak': 'è´­ç‰©',
        'ypåº—': 'è´­ç‰©',
        'daèˆ°': 'è´­ç‰©',
        'å¸¸å·åº—': 'è´­ç‰©',
        'bu4': 'è´­ç‰©',
        'æ´ºè±ªåº—': 'è´­ç‰©',
        'YHJM': 'è´­ç‰©',

        # é¤é¥®
        'é¥¿äº†ä¹ˆ': 'é¤é¥®',
        'è€å¼ ç‰¹è‰²é¢': 'é¤é¥®',
        'å°é©¬ç‚’é¸¡æ‹Œé¢': 'é¤é¥®',
        'æŠ–éŸ³ç”Ÿæ´»æœåŠ¡å•†å®¶': 'é¤é¥®',  # æŠ–éŸ³å›¢è´­é¤é¥®
        'å•†å®¶ä¼˜æƒ ': 'é¤é¥®',  # é€šå¸¸æ˜¯é¤é¥®ä¼˜æƒ åˆ¸
        'ä¸ç¾å¥³': 'é¤é¥®',
        'é™ˆé¹3': 'é¤é¥®',
        'çˆ½': 'é¤é¥®',
        'é»„æ—­ä¸œ': 'é¤é¥®',
        'æ°': 'é¤é¥®',
        'æ±ªèŠ¬': 'é¤é¥®',

        # äº¤é€š
        'é£ç¥è½®èƒ': 'äº¤é€š',

        # æ—…æ¸¸
        'è‹å·ç¨‹ä¼šç©å›½é™…æ—…è¡Œç¤¾æœ‰é™å…¬å¸': 'æ—…æ¸¸',
        'æ™ºæ…§æ—…æ¸¸å•†åŠ¡ç§‘æŠ€æœ‰é™å…¬å¸': 'æ—…æ¸¸',

        # éŸ©å›½æ¶ˆè´¹(æ—…æ¸¸/è´­ç‰©)
        'GS25 Yeondongga': 'è´­ç‰©',
        'GS25 linked hap': 'è´­ç‰©',
        '7-Eleven Seogwi': 'è´­ç‰©',
        'CU Aewoljaundan': 'è´­ç‰©',
        'e-mart new jeju': 'è´­ç‰©',
        'SAEBYOUL HEYYO': 'é¤é¥®',
    }

    # æ”¯ä»˜å®åˆ†ç±»æ˜ å°„
    ALIPAY_CATEGORY_MAP = {
        'é¤é¥®ç¾é£Ÿ': 'é¤é¥®',
        'äº¤é€šå‡ºè¡Œ': 'äº¤é€š',
        'å…¬å…±äº¤é€š': 'äº¤é€š',
        'æ—¥ç”¨ç™¾è´§': 'è´­ç‰©',
        'è´­ç‰©': 'è´­ç‰©',
        'æœé¥°ç¾å®¹': 'è´­ç‰©',
        'æ•°ç ç”µå™¨': 'è´­ç‰©',
        'å¨±ä¹': 'å¨±ä¹',
        'è¿åŠ¨å¥åº·': 'å¨±ä¹',
        'ç”Ÿæ´»æœåŠ¡': 'å®¶ç”¨',
        'å……å€¼ç¼´è´¹': 'å®¶ç”¨',
        'å®¶å±…å®¶è£…': 'å®¶ç”¨',
        'åŒ»ç–—å¥åº·': 'åŒ»ç–—',
        'æ•™è‚²å­¦ä¹ ': 'å­¦ä¹ åŠå…¬',
        'é‡‘èä¿é™©': 'å…¶ä»–',
        'çº¢åŒ…è½¬è´¦': 'çº¢åŒ…è½¬è´¦',
        'å…¶ä»–': 'å…¶ä»–'
    }

    # å¾®ä¿¡åˆ†ç±»æ˜ å°„
    WECHAT_CATEGORY_MAP = {
        'å•†æˆ·æ¶ˆè´¹': 'è´­ç‰©',
        'æ‰«äºŒç»´ç ä»˜æ¬¾': 'é¤é¥®',
        'å¾®ä¿¡çº¢åŒ…': 'çº¢åŒ…è½¬è´¦',
        'è½¬è´¦': 'çº¢åŒ…è½¬è´¦',
        'äºŒç»´ç æ”¶æ¬¾': 'å…¶ä»–æ”¶å…¥',
        'é€€æ¬¾': 'çº¢åŒ…è½¬è´¦',
        'ç†è´¢é€š': 'å…¶ä»–'
    }

    @classmethod
    def categorize(cls, source_type, category, counterparty, is_income):
        """
        æ™ºèƒ½åˆ†ç±»
        :param source_type: æ¥æºç±»å‹ 'alipay' æˆ– 'wechat'
        :param category: åŸå§‹äº¤æ˜“åˆ†ç±»
        :param counterparty: äº¤æ˜“å¯¹æ–¹
        :param is_income: æ˜¯å¦æ”¶å…¥
        :return: åˆ†ç±»ç»“æœ
        """
        # æ”¶å…¥ç±»å‹å•ç‹¬å¤„ç†
        if is_income:
            # æ£€æŸ¥å…³é”®è¯
            for keyword in cls.KEYWORD_RULES.get('å…¶ä»–æ”¶å…¥', []):
                if keyword in category or keyword in counterparty:
                    return 'å…¶ä»–æ”¶å…¥'
            return 'å·¥ä½œæ”¶å…¥'

        # 1. ä¼˜å…ˆç²¾ç¡®åŒ¹é…äº¤æ˜“å¯¹æ–¹
        if counterparty in cls.EXACT_MERCHANT_MAP:
            return cls.EXACT_MERCHANT_MAP[counterparty]

        # 2. å°è¯•åŸºäºåŸå§‹åˆ†ç±»æ˜ å°„
        if source_type == 'alipay':
            for key, val in cls.ALIPAY_CATEGORY_MAP.items():
                if key in category:
                    mapped = val
                    break
            else:
                mapped = None
        else:  # wechat
            for key, val in cls.WECHAT_CATEGORY_MAP.items():
                if key in category:
                    mapped = val
                    break
            else:
                mapped = None

        # 3. åŸºäºäº¤æ˜“å¯¹æ–¹å…³é”®è¯è¿›è¡ŒäºŒæ¬¡åˆ†ç±»
        combined_text = f"{category} {counterparty}"
        keyword_match = None
        max_matches = 0

        for cat, keywords in cls.KEYWORD_RULES.items():
            if cat == 'å…¶ä»–æ”¶å…¥':  # è·³è¿‡æ”¶å…¥ç±»
                continue

            matches = sum(1 for kw in keywords if kw in combined_text)
            if matches > max_matches:
                max_matches = matches
                keyword_match = cat

        # 4. å¦‚æœå…³é”®è¯åŒ¹é…ç½®ä¿¡åº¦é«˜,ä½¿ç”¨å…³é”®è¯åˆ†ç±»
        if max_matches >= 2 or (max_matches >= 1 and not mapped):
            return keyword_match

        # 5. å¦åˆ™ä½¿ç”¨åŸå§‹åˆ†ç±»æ˜ å°„ç»“æœ
        return mapped if mapped else 'å…¶ä»–'

    @classmethod
    def generate_note(cls, category, counterparty, final_category):
        """
        ç”Ÿæˆæ™ºèƒ½å¤‡æ³¨
        :param category: åŸå§‹åˆ†ç±»
        :param counterparty: äº¤æ˜“å¯¹æ–¹
        :param final_category: æœ€ç»ˆåˆ†ç±»
        :return: å¤‡æ³¨æ–‡æœ¬
        """
        # æ¸…ç†äº¤æ˜“å¯¹æ–¹
        if not counterparty or counterparty in ['/', 'nan', '']:
            return category[:50]

        # ç§»é™¤æ‹¬å·å†…å®¹å’Œç‰¹æ®Šå­—ç¬¦
        clean_counterparty = counterparty.split('(')[0].split('ï¼ˆ')[0].strip()
        clean_counterparty = clean_counterparty.replace('*', '').strip()

        # å¦‚æœäº¤æ˜“å¯¹æ–¹å¤ªé•¿,æˆªå–å…³é”®éƒ¨åˆ†
        if len(clean_counterparty) > 15:
            clean_counterparty = clean_counterparty[:15]

        # ç»„åˆå¤‡æ³¨: æœ€ç»ˆåˆ†ç±»-äº¤æ˜“å¯¹æ–¹
        if clean_counterparty and clean_counterparty != category:
            note = f"{final_category}-{clean_counterparty}"
        else:
            note = category

        return note[:50]
