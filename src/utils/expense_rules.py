"""
支出分类规则
基于关键词和分类的规则映射表
"""
from typing import Dict, Optional, Tuple


# 分类 → 支出目的 的默认映射
CATEGORY_TO_PURPOSE = {
    '餐饮': '生活必须',
    '家用': '生活必须',
    '交通': '生活必须',
    '医疗': '生活必须',
    '固定支出': '生活必须',

    '娱乐': '娱乐享受',
    '旅游': '娱乐享受',

    '学习办公': '自我实现',
    '理发美容': '自我实现',

    '人情': '人情社交',
    '红包转账': '人情社交',

    '购物': '娱乐享受',  # 默认，可以根据细类调整
    '财税': '未来保障',
    '贷款': '未来保障',
}


# 关键词 → (细类, 支出目的) 的映射
KEYWORD_RULES = [
    # 餐饮相关
    (['早餐', '早饭', '早点'], ('早餐', '生活必须')),
    (['午餐', '午饭', '中餐', '中饭'], ('午餐', '生活必须')),
    (['晚餐', '晚饭'], ('晚餐', '生活必须')),
    (['夜宵', '宵夜'], ('夜宵', '生活必须')),
    (['零食', '小吃', '奶茶', '咖啡', '饮料'], ('零食饮料', '娱乐享受')),
    (['水果'], ('水果', '生活必须')),
    (['外卖'], ('外卖', '生活必须')),
    (['食堂'], ('食堂', '生活必须')),
    (['聚餐', '请客', '约饭'], ('聚餐', '人情社交')),

    # 交通相关
    (['打车', '滴滴', '出租', '网约车'], ('打车', '生活必须')),
    (['地铁', '公交', '公共交通'], ('公共交通', '生活必须')),
    (['油费', '加油'], ('油费', '生活必须')),
    (['停车', '停车费'], ('停车费', '生活必须')),
    (['高速', '过路费'], ('过路费', '生活必须')),
    (['火车', '高铁'], ('火车', '生活必须')),
    (['飞机', '机票'], ('飞机', '娱乐享受')),  # 通常是旅游

    # 家用相关
    (['水电', '电费', '水费'], ('水电费', '生活必须')),
    (['燃气'], ('燃气费', '生活必须')),
    (['物业', '物业费'], ('物业费', '生活必须')),
    (['房租', '租房'], ('房租', '生活必须')),
    (['宽带', '网费'], ('网费', '生活必须')),
    (['话费', '手机', '流量'], ('话费', '生活必须')),
    (['超市', '菜市场', '买菜'], ('日用品', '生活必须')),
    (['家具', '家电'], ('家具家电', '生活必须')),

    # 购物相关
    (['淘宝', '京东', '拼多多', '网购'], ('网购', None)),  # None表示不覆盖默认
    (['衣服', '裤子', '鞋'], ('服饰', '娱乐享受')),
    (['化妆品', '护肤'], ('美妆', '自我实现')),
    (['数码', '电子产品', '手机', '电脑', '耳机'], ('数码产品', '娱乐享受')),
    (['图书', '书'], ('图书', '自我实现')),

    # 娱乐相关
    (['电影', '影院'], ('电影', '娱乐享受')),
    (['KTV', 'K歌'], ('KTV', '娱乐享受')),
    (['游戏', '充值', '皮肤'], ('游戏', '娱乐享受')),
    (['旅游', '景点', '门票'], ('旅游', '娱乐享受')),
    (['酒店', '住宿', '民宿'], ('住宿', '娱乐享受')),
    (['健身', '游泳', '瑜伽', '球'], ('健身运动', '自我实现')),

    # 学习办公
    (['培训', '课程', '学费'], ('培训学习', '自我实现')),
    (['考试', '报名费'], ('考试费用', '自我实现')),
    (['办公用品', '文具'], ('办公用品', '自我实现')),

    # 医疗相关
    (['医院', '看病', '就诊'], ('医疗费', '生活必须')),
    (['药', '买药'], ('药品', '生活必须')),
    (['体检'], ('体检', '未来保障')),

    # 人情相关
    (['红包', '发红包'], ('红包', '人情社交')),
    (['礼物', '送礼'], ('礼物', '人情社交')),
    (['份子钱', '随礼'], ('份子钱', '人情社交')),

    # 美容相关
    (['理发', '剪发', '烫发', '染发'], ('理发', '自我实现')),
    (['美容', '美甲'], ('美容', '自我实现')),

    # 其他
    (['快递', '邮费'], ('快递', '生活必须')),
    (['保险'], ('保险', '未来保障')),
]


def match_by_rules(note: str, category: str) -> Tuple[Optional[str], Optional[str]]:
    """
    基于规则匹配细类和支出目的

    :param note: 备注
    :param category: 分类
    :return: (细类, 支出目的)
    """
    note_lower = note.lower()

    # 1. 优先根据关键词匹配
    for keywords, (subcat, purpose) in KEYWORD_RULES:
        for keyword in keywords:
            if keyword in note_lower:
                # 如果规则中的purpose是None，使用分类默认值
                final_purpose = purpose if purpose else CATEGORY_TO_PURPOSE.get(category)
                return subcat, final_purpose

    # 2. 如果没有匹配到关键词，使用分类默认值
    default_purpose = CATEGORY_TO_PURPOSE.get(category)

    # 细类可以根据分类给一个默认值
    default_subcat = _get_default_subcat(category)

    return default_subcat, default_purpose


def _get_default_subcat(category: str) -> Optional[str]:
    """
    根据分类返回默认细类
    """
    subcat_map = {
        '餐饮': '日常用餐',
        '交通': '通勤',
        '家用': '日用品',
        '购物': '日常购物',
        '娱乐': '休闲娱乐',
        '学习办公': '学习',
        '医疗': '医疗',
        '人情': '人情往来',
        '固定支出': '固定支出',
        '财税': '税费',
        '旅游': '旅游',
    }
    return subcat_map.get(category)


def apply_rules_to_record(fields: Dict) -> Dict:
    """
    应用规则到记录，返回需要更新的字段

    :param fields: 记录的字段
    :return: 需要更新的字段字典
    """
    note = str(fields.get('备注', '')).strip()
    category = str(fields.get('分类', '')).strip()
    current_purpose = str(fields.get('支出目的', '')).strip()
    current_subcat = str(fields.get('细类', '')).strip()

    if not note or not category:
        return {}

    # 匹配规则
    predicted_subcat, predicted_purpose = match_by_rules(note, category)

    updates = {}

    # 只填充空字段
    if not current_purpose and predicted_purpose:
        updates['支出目的'] = predicted_purpose

    if not current_subcat and predicted_subcat:
        updates['细类'] = predicted_subcat

    return updates


if __name__ == '__main__':
    # 测试规则
    test_cases = [
        ('午餐', '餐饮'),
        ('打车回家', '交通'),
        ('超市买菜', '家用'),
        ('看电影', '娱乐'),
        ('买书', '学习办公'),
        ('理发', '理发美容'),
        ('发红包', '人情'),
        ('淘宝买衣服', '购物'),
    ]

    print("=== 规则测试 ===\n")
    for note, category in test_cases:
        subcat, purpose = match_by_rules(note, category)
        print(f"备注: {note}, 分类: {category}")
        print(f"  → 细类: {subcat}, 支出目的: {purpose}\n")
